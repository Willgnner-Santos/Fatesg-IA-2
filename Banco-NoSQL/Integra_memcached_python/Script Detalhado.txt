# Nome do Script: O Show de Comandos do Memcached
# Objetivo: Demonstrar o ciclo de vida dos dados (SET, GET, DELETE, TTL) com feedback visual em tempo real.

import memcache
import time
import sys

# Garante que a saÃ­da do console seja imediata (necessÃ¡rio para a animaÃ§Ã£o de contagem)
sys.stdout.reconfigure(encoding='utf-8') 

# --- Bloco 1: ConexÃ£o e DefiniÃ§Ãµes ---
# CORREÃ‡ÃƒO: Removido o import duplicado de 'time'.
# O cliente se conecta ao servidor Memcached (assumindo que estÃ¡ ativo no WSL)
mc = memcache.Client(['127.0.0.1:11211'], debug=0)

chave_nova = "usuario_logado_123"
valor_cache = "Dados de Sessao Complexos"
chave_expiravel = "noticia_destaque"
valor_expiravel = "Previsao do Tempo de Hoje - QUENTE!"
ttl_segundos = 5

print("\n" + "="*70)
print(f"       ğŸ§  DEMONSTRAÃ‡ÃƒO COMPLETA DE COMANDOS MEMCACHED ğŸ§ ")
print("="*70)
time.sleep(1)


# --- Bloco 2: O Comando SET (CriaÃ§Ã£o e AtualizaÃ§Ã£o) ---
print("\n[FLUXO 1: CRIAÃ‡ÃƒO E ATUALIZAÃ‡ÃƒO]")
print("----------------------------------------------------------------------")
time.sleep(1)

# A. Set Inicial (CriaÃ§Ã£o)
print(f"1.1. ğŸ’¾ SET: Criando a chave '{chave_nova}'...")
resultado_set = mc.set(chave_nova, valor_cache)
print(f"   Status: {'âœ… SUCESSO na criaÃ§Ã£o!' if resultado_set else 'âŒ FALHA!'} (Aguarde 1s)")
time.sleep(1)

# B. Get para confirmar a criaÃ§Ã£o
print(f"1.2. ğŸ” GET: Lendo a chave recÃ©m-criada para confirmar...")
valor_lido = mc.get(chave_nova)
# CORREÃ‡ÃƒO: Removido .decode()
print(f"   Resultado: '{valor_lido}'")
time.sleep(1)

# C. Set de AtualizaÃ§Ã£o
novo_valor = "Dados de Sessao ATUALIZADOS e FRESCOS"
print(f"1.3. ğŸ”„ SET: Atualizando a chave '{chave_nova}' com novo valor...")
mc.set(chave_nova, novo_valor)
time.sleep(1)

# D. Get para confirmar a atualizaÃ§Ã£o
print(f"1.4. ğŸ” GET: Lendo apÃ³s atualizaÃ§Ã£o...")
valor_atualizado = mc.get(chave_nova)
# CORREÃ‡ÃƒO: Removido .decode()
print(f"   Resultado: '{valor_atualizado}' (âœ… Chave sobrescrita com sucesso!)")
time.sleep(1)


# --- Bloco 3: O Comando DELETE (RemoÃ§Ã£o ForÃ§ada) ---
print("\n[FLUXO 2: REMOÃ‡ÃƒO FORÃ‡ADA]")
print("----------------------------------------------------------------------")
time.sleep(1)

# A. Delete
print(f"2.1. ğŸ—‘ï¸ DELETE: Removendo a chave '{chave_nova}'...")
resultado_delete = mc.delete(chave_nova)
print(f"   Status: {'âœ… SUCESSO na remoÃ§Ã£o!' if resultado_delete else 'âŒ FALHA!'} (Aguarde 1s)")
time.sleep(1)

# B. Get apÃ³s o delete
print(f"2.2. ğŸ•µï¸â€â™€ï¸ GET: Tentando ler a chave apÃ³s o DELETE...")
valor_apos_delete = mc.get(chave_nova)

if valor_apos_delete is None:
    print("   âœ… SUCESSO: O valor retornado Ã© None. A chave sumiu como esperado!")
else:
    # CORREÃ‡ÃƒO: Removido .decode()
    print(f"   âŒ ERRO: A chave ainda existe! Valor lido: {valor_apos_delete}")
print("-" * 70)
time.sleep(1)


# --- Bloco 4: O Comando SET com TTL (Time To Live - O Show Principal!) ---
print("\n[FLUXO 3: O SHOW DO TTL - PERSISTÃŠNCIA SEGUNDO A SEGUNDO]")
print("----------------------------------------------------------------------")
time.sleep(1)

# A. Set com TTL
print(f"3.1. â±ï¸ SET TTL: Armazenando '{chave_expiravel}' com {ttl_segundos} segundos de vida...")
mc.set(chave_expiravel, valor_expiravel, ttl_segundos)
time.sleep(1)

# B. Loop de Contagem Regressiva e VerificaÃ§Ã£o (Segundo a Segundo)
print("\n3.2. â³ CONTANDO: Verificando a vida do dado no cache...")
for i in range(ttl_segundos + 2): # Roda 2 segundos a mais para garantir a expiraÃ§Ã£o visÃ­vel
    valor_atual = mc.get(chave_expiravel)
    
    if valor_atual is not None:
        # CORREÃ‡ÃƒO: Removido .decode()
        segundos_restantes = ttl_segundos - i
        icone = "âœ¨" if segundos_restantes > 0 else "ğŸ’¤"
        
        # Uso de \r (retorno de carro) para atualizar a mesma linha
        print(f"   {icone} {i+1}s: Dado '{chave_expiravel}' ATIVO! Estou aqui atÃ© o segundo {ttl_segundos}. (Valor: {valor_atual})", end='\r', flush=True)
    else:
        # ExpiraÃ§Ã£o detectada
        print(f"   ğŸ’¥ {i+1}s: CHAVE EXPIRADA! O Memcached removeu o dado automaticamente!                                                               ")
        break # Sai do loop apÃ³s a expiraÃ§Ã£o

    time.sleep(1)

# 4. ConclusÃ£o
print("\n\n" + "="*70)
print("             ğŸ‰ DEMONSTRAÃ‡ÃƒO COMPLETA CONCLUÃDA! ğŸ‰")
print("======================================================================\n")
