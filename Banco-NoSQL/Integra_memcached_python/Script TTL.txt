# Nome do Script: Demonstra√ß√£o Interativa do TTL
# Objetivo: Mostrar a persist√™ncia e a expira√ß√£o do Memcached segundo a segundo.
#
# OBSERVA√á√ÉO: Este script assume que o Memcached est√° rodando em 127.0.0.1:11211
# e que a biblioteca python-memcached est√° instalada no seu ambiente virtual (VENV).

import memcache
import time
import sys

# --- Configura√ß√£o ---
mc = memcache.Client(['127.0.0.1:11211'], debug=0)
chave_teste = "chave_secreta_do_cache"
valor_teste = "üöÄ Dados Vivos e Carregados!"
ttl_segundos = 7  # Aumentei para 7s para uma contagem mais vis√≠vel
tempo_de_vida = ttl_segundos

# Garante que a sa√≠da do console seja imediata (necess√°rio para a anima√ß√£o da contagem)
sys.stdout.reconfigure(encoding='utf-8') 

print("\n" + "="*70)
print(f"       ‚è±Ô∏è INICIANDO DEMONSTRA√á√ÉO: TTL ({tempo_de_vida} segundos) ‚è±Ô∏è")
print("="*70)

# 1. Armazenamento com TTL
print(f"\n1Ô∏è‚É£ GRAVANDO: Chave '{chave_teste}' armazenada com {ttl_segundos} segundos de vida...")
mc.set(chave_teste, valor_teste, ttl_segundos)

# 2. Leitura Inicial (Verifica√ß√£o se o dado existe)
valor_lido = mc.get(chave_teste)
if valor_lido is None:
    print("   ‚ùå ERRO DE CONEX√ÉO: O Memcached n√£o est√° acess√≠vel ou a chave falhou.")
    exit()
else:
    # CORRE√á√ÉO: Removido o .decode() para evitar Attribute Error.
    print(f"   ‚úÖ SUCESSO! Valor Lido: {valor_lido}")

print("\n2Ô∏è‚É£ PERSIST√äNCIA: Monitorando a expira√ß√£o do cache...")

# 3. Loop Divertido para Mostrar a Persist√™ncia
for i in range(tempo_de_vida + 3):  # 3 segundos a mais para mostrar o estado final
    valor_atual = mc.get(chave_teste)
    
    if valor_atual is not None:
        # Ainda est√° no cache
        segundos_restantes = tempo_de_vida - i
        icone = "üü¢" if segundos_restantes > 2 else "üü°"
        
        # Imprime na mesma linha (flush=True necess√°rio no Python 3)
        print(f"   {icone} {i+1}s: Cache ATIVO! Vai expirar em ~{segundos_restantes} segundos...", end='\r', flush=True)
    else:
        # Expirou
        print(f"   üî¥ {i+1}s: CACHE EXPIRADO! A chave '{chave_teste}' foi REMOVIDA automaticamente.      ")
        break # Sai do loop ap√≥s a expira√ß√£o

    time.sleep(1)

# 4. Verifica√ß√£o Final P√≥s-Expira√ß√£o
print("\n\n3Ô∏è‚É£ COMPROVA√á√ÉO FINAL (Nova tentativa de GET):")
valor_final = mc.get(chave_teste)

if valor_final is None:
    print(f"   üéâ VIT√ìRIA TTL: O valor sumiu com sucesso! A expira√ß√£o funcionou 100%.")
else:
    # Este bloco s√≥ deve ser atingido em caso de erro.
    print(f"   ‚ö†Ô∏è ERRO: O valor ainda est√° l√°! {valor_final}")

print("\n" + "="*70)
print("             Demonstra√ß√£o de Persist√™ncia Conclu√≠da!")
print("="*70 + "\n")
